---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r, include = FALSE}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      cache = TRUE)
```

```{r}
# core libraries
library(tidyverse)
library(rstanarm)

# helper packages
library(janitor) # for clean names

# global settings
theme_set(theme_light())
```

## Introduction

### Objectives

-   To develop a regression model to predict the amount of plastic waste created by a country

-   Compare the performance of several regression models and choose the best performing.

-   To predict future plastic waste production

### The anticipated audience of the notebook

-   ...

-   ...

### Structure of the notebook

1.  ....

2.  .....

### The datasets used

All data files are located in `/data/`

+---------------------------------+--------------------------------+--------------------------------------------+--------------------------------------------------------+
| File Name                       | Variable name in this notebook | Notes                                      | More details                                           |
+=================================+================================+============================================+========================================================+
| '../data/coast_vs_waste.csv'    | coast_vs_waste                 | Data provided by \#tidytuesday             | <https://ourworldindata.org/plastic-pollution#summary> |
|                                 |                                |                                            |                                                        |
|                                 |                                | -   via our world in data;                 | <https://jambeck.engr.uga.edu/landplasticinput>        |
|                                 |                                |                                            |                                                        |
|                                 |                                | -   source: Jambeck et al. 2015 (see link) |                                                        |
+---------------------------------+--------------------------------+--------------------------------------------+--------------------------------------------------------+
| '../data/mismanaged_vs_gdp.csv' | mismanaged_vs_gdp              | Data provided by \#tidytuesday             | <https://ourworldindata.org/plastic-pollution#summary> |
|                                 |                                |                                            |                                                        |
|                                 |                                | -   via our world in data;                 | <https://jambeck.engr.uga.edu/landplasticinput>        |
|                                 |                                |                                            |                                                        |
|                                 |                                | -   source: Jambeck et al. 2015 (see link) |                                                        |
+---------------------------------+--------------------------------+--------------------------------------------+--------------------------------------------------------+
| '../data/waste_vs_gdp.csv'      | waste_vs_gdp                   | Data provided by \#tidytuesday             | <https://ourworldindata.org/plastic-pollution#summary> |
|                                 |                                |                                            |                                                        |
|                                 |                                | -   via our world in data;                 | <https://jambeck.engr.uga.edu/landplasticinput>        |
|                                 |                                |                                            |                                                        |
|                                 |                                | -   source: Jambeck et al. 2015 (see link) |                                                        |
+---------------------------------+--------------------------------+--------------------------------------------+--------------------------------------------------------+

### A summary of findings / conclusions

### Other notes / reflections

## Data import

The data was provided by \#TidyTuesday, a weekly data science challenge run the R for Data Science Community. Each week a dataset is posted for data scientists to practice their data wrangling and visualisation skills. [In May 2019 \#TidyTuesday posted three datasets](https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-05-21) (sourced from our world in data) providing three datasets focussing on plastic waste production, coastal populations and economic activity. The data is provided (mainly) at the country scale.

Below I read in the three datasets and quickly clean up some of the variable names to make them easier to work with.

```{r}

# read dataset 1 of 3
coast_vs_waste <- read_csv('../data/coast_vs_waste.csv') %>% 
  clean_names() %>% 
  rename(country = entity,
         country_code = code)

# read dataset 2 of 3
mismanaged_vs_gdp <- read_csv('../data/mismanaged_vs_gdp.csv') %>% 
  clean_names() %>% 
  rename(country = entity,
         country_code = code,
         mismanaged_plastic_per_cap =
           per_capita_mismanaged_plastic_waste_kilograms_per_person_per_day)

# read dataset 3 of 3
waste_vs_gdp <- read_csv('../data/waste_vs_gdp.csv') %>% 
  clean_names() %>% 
  rename(country = entity,
         country_code = code,
         population = total_population_gapminder,
         gdp_per_cap =
           gdp_per_capita_ppp_constant_2011_international_constant_2011_international,
         plastic_waste_per_cap =
           per_capita_plastic_waste_kilograms_per_person_per_day)
```

## Data cleaning

### Missing data

I started the analysis with the idea that there could be relationship between the amount of plastic waste produced by a country and the size of its economy. So, I focused on just one of the three \#TidyTuesday datasets `waste_vs_gdp`.

```{r}
# show data for initial inspection
waste_vs_gdp

# visualise missing data across variables
waste_vs_gdp %>% 
  arrange(country, year) %>% 
  visdat::vis_dat()
```

Quickly looking at the data and plot above:

-   I am happy the data types for each variable are appropriate and that the variables look to be in tidy format.

-   I can see that it is presented as a longitudinal dataset with each row consisting of an observation for a country (or another entity - e.g. a group of countries) for a specific year.

-   However, the variable I am interesting in predicting (plastic waste) most of the data is missing ...

There is data on plastic waste production for 2010 (see below). So, data for other years can be removed.

```{r}
# find out what plastic waste data is actually available
waste_vs_gdp %>% 
  filter(!is.na(plastic_waste_per_cap)) %>% 
  distinct(year)

# remove observations where there is no plastic waste data available
waste_vs_gdp <- waste_vs_gdp %>% 
  filter(!is.na(plastic_waste_per_cap))
```

Taking another at the missing data (just for the year 2010):

-   I can see there is some missing data for `gdp_per_cap` . I'm thinking that this variable will be used as a predictor later on in a linear regression model, so I looked at the missing data in a more detail.

-   Based on a quick inspect, the 38 entities without `gdp_per_cap` data (see below) look to fall into two categories:

    -   small dependencies, territories and islands which form part of larger countries, for example Gibraltar which is part of the UK.

    -   countries where is it might be difficult to quantify GDP, for example North Korea and Cuba.

-   Although, it means losing approximately 20% of the dataset I think the best option is to omit these countries from the analysis. As at the moment I can't think of a way to reliably impute GDP values for these 38 entities (particularly as they may have different economic characteristics from typical larger countries).

```{r}
# look again at where things are at in terms of missing data
waste_vs_gdp %>% 
  visdat::vis_miss()

# check which countries/entities have no GDP data
waste_vs_gdp %>% 
  filter(is.na(gdp_per_cap)) %>% 
  distinct(country, country_code)

# remove countries with no GDP data
waste_vs_gdp <- waste_vs_gdp %>% 
  filter(!is.na(gdp_per_cap))

```

So, looking for the last time at missing data there is just the missing data for population to consider:

-   As it is just three countries without population data I am comfortable with omitting these from the analysis.

```{r}
# look again at where things are at in terms of missing data
waste_vs_gdp %>% 
  visdat::vis_miss()

# check which entities/countries don't have population data
waste_vs_gdp %>% 
  filter(is.na(population)) %>% 
  distinct(country, country_code)

# remove observations without population information  
waste_vs_gdp <- waste_vs_gdp %>% 
  filter(!is.na(population))

```

### Inspecting the data for the country variable

Given the raw data used the variable name (geographic) entity rather than `country` I wanted to check that the cleaned data only contains countries. Given there are only 145 observations remaining in the dataset, I did this check manually. There were no obvious non-country entities (e.g. continents such as Europe or Asia, or high/middle/low income country groups) remaining.

```{r}
waste_vs_gdp %>% 
  select(country, country_code)
```

I also confirmed there are no duplicates of countries within the dataset.

```{r}
# confirm there are no duplicate countries
assertthat::are_equal(nrow(waste_vs_gdp),
                      nrow(waste_vs_gdp %>% 
                             distinct(country))
)


```

```{r}
# reassign at dataframe at the end of the data cleaning process
waste_vs_gdp_cleaned <- waste_vs_gdp
```

## Exploratory data analysis

The plastic waste and gdp data are represented on a per capita basis (`plastic_waste_per_cap` and `gdp_per_cap` respectively). During the modelling process I think it will be useful to have the absolute values for plastic waste and gdp. Fortunately, population data is provide so it is easy to calculate these figures.

Having calculated `plastic_waste_tot`, I think it make sense to adjust the units to tonnes of waste per year (`plastic_waste_per_cap` was in kg per day per person). Just to confirm that the transformation I sum `plastic_waste_tot` to give global plastic waste for 2010 (which is approx. 269 million tonnes ). This is close enough to the headline figure of 275 million tonnes of global plastic waste for 2010 given by [Jambeck et al.](https://jambeck.engr.uga.edu/landplasticinput) (), to be confident nothing major has gone wrong in my calculation.

```{r}
# create new variables for eda and regression
waste_vs_gdp_eda <- waste_vs_gdp_cleaned %>% 
  mutate(plastic_waste_tot = plastic_waste_per_cap * population,
         gdp = gdp_per_cap * population,
         
         # adjust units
         plastic_waste_tot = (plastic_waste_tot / 1000) * 365
         )

waste_vs_gdp_eda %>% 
  summarise(sum(plastic_waste_tot)) %>% 
  pull()
```

From the summary statistics (see below) for the outcome variable (`plastic_waste_tot`) and the two potential predictor variables (`gdp` and `population`), it looks like all three will be heavily right-skewed. And, this is confirmed by the plots below which apply a log scale to the x axis.

So, I start with a little bit of very basic feature engineering and take logs of the three variables to produce outcome and predictors with more normal-like distributions.

```{r}
# produce summary statistics
waste_vs_gdp_eda %>% 
  select(-year) %>% 
  skimr::skim() %>% 
  skimr::yank("numeric")

# define labels for plotting
x_lab_pop <- "Plastic waste produced (tonnes per year)"
x_lab_gdp <- "\n2010 GDP (USD)\n\nadjusted for inflation (2011 benchmark year) and purchaing power parity"
y_lab <- "Number of countries"
caption_lab <- "Source: ourworldindata / gapminder"

# plot transformed variables
p <- ggplot(waste_vs_gdp_eda)

p + geom_histogram(aes(plastic_waste_tot)) +
  scale_x_log10(labels = scales::comma) +
  labs(x = x_lab_pop,
       y = y_lab,
       caption = caption_lab )

p + geom_histogram(aes(gdp)) +
  scale_x_log10(labels = scales::label_number_si(accuracy=0.1)) +
  labs(x = x_lab_gdp,
       y = y_lab,
       caption = caption_lab)

p + geom_histogram(aes(population)) +
  scale_x_log10(labels = scales::comma) +
  labs(x = "Population",
       y = y_lab,
       caption = caption_lab)

# transform skewed variables
waste_vs_gdp_eda <- waste_vs_gdp_eda %>% 
  mutate(across(.cols = population:gdp,
                .fns = log,
                .names = "log_{.col}")
         )



```

There is a high degree of correlation between the logs each of the predictor variables (`population` and `gdp`) and the log of the outcome variable (`plastic_waste_tot`)(see below). This is promising in terms of developing a predictive linear regression model).

However, there is also evidence of multicollinearity (i.e. a high degree of correlation between the two predictor variable). If both are included in a linear regression model there is the potential for standard errors of the regression coefficients to increase (relative to a model containing only one of the two predictors). This is something to come back to in the comparision of model performance below.

```{r}
GGally::ggpairs(waste_vs_gdp_eda %>% select(starts_with("log_")))
```

## A simple regression model

### Model fitting

Below I fit three linear models (using a Bayesian linear regression algorithm from the `rstanarm` package) with `plastic_waste_tot` as the outcome variable. The three models have different predictors as follows:

1.  Using `gdp` as a single predictor;

2.  Using `population` as a single predictor;

3.  Using both `gdp` and `population` as predictors.

Reviewing the outputs of the three model fits I noted the following:

-   The residual standard deviation (sigma in the output below) is highest for model 1 and lowest for model 3.

-   The uncertainty around the values of the regression coefficients (MAD_SD in the output below) is smallest for model 2.

Below I explore these two points further by visualising the residuals and the uncertainty around the regression coefficients.

```{r}
# reassign data at the start of modelling section
waste_vs_gdp_mod <- waste_vs_gdp_eda 

# fit models
lm_1 <- stan_glm(formula = log_plastic_waste_tot ~ log_gdp, 
                 data = waste_vs_gdp_mod,
                 refresh = 0)

lm_2 <- update(lm_1, formula = log_plastic_waste_tot ~ log_population)
lm_3 <- update(lm_1, formula = log_plastic_waste_tot ~ log_gdp + log_population)

# display model outputs
lm_1
lm_2
lm_3
```

### Uncertainty in the model fit

For the first two models (those with just a single continuous predictor) it is straight-forward to plot the regression line alongside the raw data. The uncertainty associated with the regression line was added by plotting randomly sampled draws from the posterior distribution (for the regression coefficients).

For both these simple single predictor models a good fit between the model and the data can be observed. Additionally the uncertainty around the intercept and gradient terms of the regression line appears to be relatively limited.

```{r}

plot_lm_with_uncertainty <- function(model, data, x, y){
  
  lm_coef <- coef(model)
  
  # sample draws from the posterior distribution
  posterior_coef_draws <- as_tibble(model) %>% 
    rename(a = `(Intercept)`,
           b = {{x}}) %>% 
    sample_n(100)
  
  # produce regression plot (including uncertainty)
  ggplot(data,
         aes({{x}}, {{y}})) +
    geom_point() +
    
    geom_abline(data = posterior_coef_draws,
                mapping = aes(intercept = a,
                              slope = b),
                colour = 'skyblue',
                alpha = 0.3, size = 0.2) +  # a sample of posterior to show                                                    uncertainty
    
    geom_abline(intercept = lm_coef[1], slope = lm_coef[2],
                size = 1) # estimated regression line
  
}

plot_lm_with_uncertainty(lm_1, waste_vs_gdp_mod, 
                         log_gdp, log_plastic_waste_tot) +
  labs(x = "Log GDP",
       y = "Log total annual plastic waste")

plot_lm_with_uncertainty(lm_2, waste_vs_gdp_mod, 
                         log_population, log_plastic_waste_tot) +
  labs(x = "Log Population",
       y = "Log total annual plastic waste")
```

### Reviewing the residuals

Looking at the residuals for each of the three models (see below) a similar pattern is present. As the amount of plastic waste produced by a country grows so do the residuals. In all three models the residuals diverge from 0 from predictions of approximately 0.5 million tonnes of plastic per year upwards. This suggest that for countries producing larger amounts of plastic the models are

```{r}

residuals <- waste_vs_gdp_mod %>% 
  mutate(pred_lm_1 = exp(predict(lm_1)),
         pred_lm_2 = exp(predict(lm_2)),
         pred_lm_3 = exp(predict(lm_3))) %>% 
  
  select(plastic_waste_tot,
         starts_with("pred_")) %>% 
  
  mutate(resid_lm_1 = plastic_waste_tot - pred_lm_1,
         resid_lm_2 = plastic_waste_tot - pred_lm_2,
         resid_lm_3 = plastic_waste_tot - pred_lm_3)

plot_residuals <- function(data, x, y, ...){
  ggplot(residuals,
         aes({{x}}, {{y}})) +
    geom_hline(yintercept = 0, colour = "grey50") +
    geom_point() +
    scale_x_log10(labels = scales::comma) +
    #coord_cartesian(ylim = c(-4.25e7, 4.25e7)) +
    labs(y = "Residual\n(Tonnes of plastic waster per year)")
}

plot_residuals(residuals, pred_lm_1, resid_lm_1) +
  labs(x = "predicted value\nlm_1 (log_plastic_waste_tot ~ log_gdp)")

plot_residuals(residuals, pred_lm_2, resid_lm_2) +
  labs(x = "predicted value\nlm_1 (log_plastic_waste_tot ~ log_population)")

plot_residuals(residuals, pred_lm_3, resid_lm_3) +
  labs(x = "predicted value\nlm_1 (log_plastic_waste_tot ~ log_gdp + log_population)")
```

I was wondering if the trend above would remain if I plotted the residuals as a proportion of the observed value (see below). This allowed me to get a sense of the errors in the models accounting for the wide variation in the amounts of plastic waste produced by the countries in the dataset (ranging from below 1000 tonnes per year to over 10 million tonnes). There is some indication in the plots below that all three of the models perform better for countries producing small amounts of plastic waste and worse for countries producing large amounts. However, the trend is less pronounced than in the plots of the raw residuals.

```{r}
plot_residuals_perc <- function(data, x, y, ...){
  ggplot(residuals,
         aes({{x}}, {{y}} / plastic_waste_tot)) +
    geom_hline(yintercept = 0, colour = "grey50") +
    geom_point() +
    scale_x_log10(labels = scales::comma) +
    #coord_cartesian(ylim = c(-4.25e7, 4.25e7)) +
    labs(y = "Residual / observed value")
}

plot_residuals_perc(residuals, pred_lm_1, resid_lm_1) +
  labs(x = "predicted value\nlm_1 (log_plastic_waste_tot ~ log_gdp)")

plot_residuals_perc(residuals, pred_lm_2, resid_lm_2) +
  labs(x = "predicted value\nlm_1 (log_plastic_waste_tot ~ log_population)")

plot_residuals_perc(residuals, pred_lm_3, resid_lm_3) +
  labs(x = "predicted value\nlm_1 (log_plastic_waste_tot ~ log_gdp + log_population)")
```

### Bayesian R squared

$\frac{\text{Explained Variance}}{\text{Explained Variance + Residual Variance}} = \frac{var_{fit}}{var_{fit} + var_{res}}$

Posterior distributions of Bayesian R^2^

```{r}

tribble(
  ~model, ~r2,
  1, median(bayes_R2(lm_1)),
  2, median(bayes_R2(lm_2)),
  3, median(bayes_R2(lm_3))
) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling()

plot_bayes_r2 <- function(mod){
  
  bayes_R2(mod) %>%
    as_tibble() %>% 
    ggplot(aes(value)) +
    geom_histogram(colour = "black") +
    geom_vline(aes(xintercept = median(value)),
               colour = "black", size = 2) +
    labs(x = "Bayesian R Squared")
}

plot_bayes_r2(lm_1)
plot_bayes_r2(lm_2)
plot_bayes_r2(lm_3)

```
